%__BEGIN_PACKAGES__%
\usepackage{babel}
\usepackage{etoolbox}
\usepackage{xargs}
\usepackage[svgnames]{xcolor}
\usepackage{tikz,scsnowman}
\usetikzlibrary{calc, positioning, decorations.pathmorphing, shadings}
\usepackage{pgfplotstable, array, booktabs, colortbl} %For \ExamCoverPage and \PresenceSheet
%__END_PACKAGES__%


%__BEGIN_DEFINITIONS__%
\pgfplotsset{compat=1.13}
\newlength{\myskip}
\setlength{\myskip}{6mm plus 1mm minus 1mm}

\newcommand{\CountTutors}{
    \newbool{printtutor}                    %etoolbox package
    \setbool{printtutor}{true}              %etoolbox package
    \newcounter{NumberOfTutor}
    \whileboolexpr{bool{printtutor}}{       %etoolbox package (sec. 3.6.5)
        \refstepcounter{NumberOfTutor}
        \checkTutor(\theNumberOfTutor)      %arrayjob package
        \ifemptydata                        %arrayjob package
            \setbool{printtutor}{false}     %etoolbox package
        \fi
    }
    \addtocounter{NumberOfTutor}{-1}
}

\definecolor{consolegray}{RGB}{192,192,192}
\newcommand{\Heading}[1][true]{
    \newbool{printTutorList}                %etoolbox package
    \setbool{printTutorList}{#1}            %etoolbox package
    \begin{tikzpicture}[remember picture, overlay]
        %Coordinates
        \path coordinate (NW1)  at (current page.north west)
              coordinate (NW2)  at ([xshift=+45mm]NW1)
              coordinate (NW3)  at ([yshift=-45mm]NW1)
              coordinate (NWM)  at ($(NW2)!0.5!(NW3)$)
              coordinate (NE)   at (current page.north east)
              coordinate (L)    at ([shift={(-5mm,-5mm)}]current page.north east);
        %Corner decoration with sun for semester
        \shade[upper left=DodgerBlue,lower right=DodgerBlue] (NW1) -- (NW2) -- (NW3) -- cycle;
        \coordinate (sun) at ($(NW1)!0.57!(NWM)$);
        \draw[fill=yellow!20!orange, decorate, decoration={zigzag, segment length=4.187mm, amplitude=1.8mm}] (sun) circle (1cm);
        \draw[very thin] (sun) circle (8mm);
        \shade[shading=radial, inner color=yellow!80, outer color=yellow!20!orange, ] (sun) circle (8mm);
        \node[font=\scshape] at (sun) {
            \begin{tabular}{c}
                \semester
            \end{tabular}
        };
        %Blackboard content
        \node[text=white, text width=14cm, align=center, fill=black, anchor=north] (lecture) at ($(NW2)!0.5!(NE)+(0,-8mm)$) {
            \textsc{\professor} \\[1.5ex]
            {\LARGE\scshape\lecture} \\[-1ex]
            \rule{11cm}{0.4pt} \\
            \CountTutors
            \foreach \n in {1,...,\theNumberOfTutor}{
                \textsc{\Tutor(\n):} \texttt{\TutorMail(\n)} \\
            }
        };
        %Blackboard frame
        \pgfmathsetmacro{\framewidth}{5pt}
        \path coordinate (LNWshifted) at ($(lecture.north west)+(-\framewidth pt,\framewidth pt)$)
              coordinate (LNEshifted) at ($(lecture.north east)+(\framewidth pt,\framewidth pt)$)
              coordinate (LSEshifted) at ($(lecture.south east)+(\framewidth pt,-\framewidth pt)$)
              coordinate (LSWshifted) at ($(lecture.south west)+(-\framewidth pt,-\framewidth pt)$);
        \shade[left color=consolegray!70!black,right color=consolegray, middle color=consolegray!10!white] %left
            (lecture.south west) -- (lecture.north west) -- (LNWshifted)  -- (LSWshifted) -- cycle ;
        \shade[top color=consolegray!70!black,bottom color=consolegray, middle color=consolegray!10!white] %top
            (lecture.north west) -- (lecture.north east) -- (LNEshifted)  -- (LNWshifted) -- cycle ;
        \shade[left color=consolegray,right color=consolegray!70!black, middle color=consolegray!10!white] %right
            (lecture.north east) -- (lecture.south east) -- (LSEshifted)  -- (LNEshifted) -- cycle ;
        \shade[top color=consolegray,bottom color=consolegray!70!black, middle color=consolegray!10!white] %bottom
            (lecture.south east) -- (lecture.south west) -- (LSWshifted)  -- (LSEshifted) -- cycle ;
    \end{tikzpicture}\par
    \vspace{-0.5\myskip}
}

\makeatletter

\newcommandx{\Sheet}[3][2=, 3=]{
    \ifstrempty{#2}{
        \centerline{\Large\textbf{\EH@Translate{#1}}}
    }{
        \centerline{\Large\textbf{\EH@Translate{#1} #2}}
    }
    % Print subtitle only for exercises
    \ifstrequal{#1}{exercise-sheet}{
        % Here we have to print as subtitle a string which is the concatenation
        % of \exerciseSheetSubtitlePrefix and #3, which could be empty or not in
        % all the possible combinations. So test them.
        \expandafter\ifstrempty\expandafter{\exerciseSheetSubtitlePrefix}{ % https://tex.stackexchange.com/a/24924
            \ifstrempty{#3}{}{
                \centerline{\textit{#3}}
            }
        }{
            \ifstrempty{#3}{
                \centerline{\textit{\exerciseSheetSubtitlePrefix}}
            }{
                \centerline{\textit{\exerciseSheetSubtitlePrefix{} #3}}
            }
        }
    }{}
    % Print current date as subtitle only for presence sheet
    \ifstrequal{#1}{presence-sheet}{
        \ifstrempty{#3}{
            \centerline{\today}
        }{
            \centerline{\textit{#3}}
        }
    }{}
    % Print exam date as subtitle for exam solution
    \ifstrequal{#1}{exam-solution}{
        \centerline{\EH@Translate{exam-date}: \examDate{}}
    }{}
    \vspace{2\myskip}
}

\newcommand{\ExamCoverPage}[2]{%
    \thispagestyle{empty}
    \begingroup
        \large
        \noindent\textbf{\EH@Translate{duration}:} \examDuration  \hfill \textbf{\examDate}
        \par% https://tex.stackexchange.com/a/91539
    \endgroup
    \vfill%
    \examRules%
    \vfill%
    \begingroup
        \large
        \centering
        \begin{tabular}{rp{0.6\textwidth}}
            \EH@Translate{full-name}:  & \underline{\hspace{0.6\textwidth}} \\[3ex]
            \EH@Translate{ID-number}:  & \underline{\hspace{0.6\textwidth}} \\[4ex]
        \end{tabular}
        %Prepare table formatting and layout
        \setlength{\aboverulesep}{0pt}
        \setlength{\belowrulesep}{0pt}
        \renewcommand{\arraystretch}{1.8}
        \newcolumntype{?}{!{\vrule width \heavyrulewidth}}
        \newcolumntype{C}{>{\centering\arraybackslash}p{0.2\textwidth}}
        \pgfmathsetmacro{\numberOfExercises}{#1}
        %Sum exercise points -> https://tex.stackexchange.com/a/336724
        \pgfmathsetmacro{\totalScore}{0}%
        \foreach \i in {#2}{%
          \pgfmathsetmacro\totalScore{int(\totalScore+\i)}
          \xdef\totalScore{\totalScore}%
        }%
        \pgfmathparse{\totalScore}
        %Prepare and make table
        \pgfplotstableset{%
               brackets/.style={postproc cell content/.append style={/pgfplots/table/@cell content/.add={\relax$\;\quad$/}{}}},
               columns/Ex/.style={int detect,column type=?C|,column name=\textsc{\EH@Translate{exercise}}},
               columns/Score/.style={string type, brackets, column type=C?,column name=\textsc{\EH@Translate{score}}},
               create on use/Ex/.style={create col/set list={1,...,\numberOfExercises}},
               create on use/Score/.style={create col/set list={#2}},
        }
        \pgfplotstablenew[columns={Ex,Score}]{\numberOfExercises}{\loadedtable}
        \pgfplotstabletypeset[
               every head row/.style={before row=\toprule, after row=\midrule},
               every even row/.style={before row={\rowcolor{\myEveryEvenRowColor}}},
               every last row/.style={after row=\midrule \textsc{\EH@Translate{sum}:} & $\;\quad/\totalScore$ \\ \bottomrule}]{\loadedtable}
        \par\vspace{\myskip}
        \newbool{examIsPassedOrFailed}
        \setbool{examIsPassedOrFailed}{\makeBinaryExam}
        \ifbool{examIsPassedOrFailed}{%
            \begin{tabular}{rp{2cm}p{2cm}}
                \EH@Translate{passed}: & \fbox{\phantom{X}}$\quad$\EH@Translate{yes} & \fbox{\phantom{X}}$\quad$\EH@Translate{no} \\
            \end{tabular}
        }{%
            \begin{tabular}{rp{10cm}}
                \EH@Translate{final-mark}:       & \underline{\hspace{9cm}} \\
            \end{tabular}
        }
        \par% https://tex.stackexchange.com/a/91539
    \endgroup
    \vfill
    \newpage%
    \pagenumbering{arabic}% Arabic page numbers (and reset to 1)
}

\newcommand{\PresenceSheet}[6]{
    \begingroup
        \centering
        %Some macros for later
        \pgfmathsetmacro{\myNumberOfStudents}{#4}
        \pgfmathsetmacro{\myNumberOfExercises}{#3}
        \pgfmathsetmacro{\counter}{-1}
        \pgfmathsetmacro{\myColWidth}{0.31}
        \pgfmathsetmacro{\myHalfColWidth}{0.155}
        \pgfmathsetmacro{\mySubColWidth}{\myColWidth / \myNumberOfExercises}
        %Table layout
        \setlength{\tabcolsep}{0pt}
        \setlength{\aboverulesep}{0pt}
        \setlength{\belowrulesep}{0pt}
        \renewcommand{\arraystretch}{2}
        \newcolumntype{C}{>{\centering\arraybackslash}p{\myColWidth\textwidth}}
        \newcolumntype{S}{>{\centering\arraybackslash}p{\myHalfColWidth\textwidth}}
        \newcolumntype{D}{>{\centering\arraybackslash}p{0.07\textwidth}}
        \newcolumntype{E}{>{\centering\arraybackslash}p{\mySubColWidth\textwidth}}
        \newcolumntype{?}{!{\vrule width \heavyrulewidth}}
        %Show/hide columns depending on user setup
        \newbool{switchOffSignatureColumnForPresenceSheet}
        \newbool{switchOffExercisesColumnForPresenceSheet}
        \newbool{biWeekly}
        \setbool{switchOffSignatureColumnForPresenceSheet}{\hideSignatureColumnInPresenceSheet}
        \setbool{switchOffExercisesColumnForPresenceSheet}{\hideExercisesColumnInPresenceSheet}
        \setbool{biWeekly}{#6}
        \ifbool{switchOffSignatureColumnForPresenceSheet}{%
            \ifbool{switchOffExercisesColumnForPresenceSheet}{%
                \edef\colNames{No.,Name}
            }{%
                \edef\colNames{No.,Name#2}
            }
        }{%
            \ifbool{switchOffExercisesColumnForPresenceSheet}{%
                \ifbool{biWeekly}{\edef\colNames{No.,Name,Signature1,Signature2}}
                {\edef\colNames{No.,Name,Signature}}
            }{%
                \ifbool{biWeekly}{\edef\colNames{No.,Name,Signature1,Signature2#2}}
                {\edef\colNames{No.,Name,Signature#2}}
            }
        }
        \ifbool{switchOffSignatureColumnForPresenceSheet}{%
            \ifbool{switchOffExercisesColumnForPresenceSheet}{%
                \def\headerString{\toprule & }
            }{%
                \def\headerString{\toprule & & \multicolumn{\myNumberOfExercises}{C?}{\textsc{Exercises}}}
            }
        }{%
            \ifbool{switchOffExercisesColumnForPresenceSheet}{%
                \ifbool{biWeekly}{\def\headerString{\toprule & & \multicolumn{2}{C?}{\textsc{Signatures}}}}
                {\def\headerString{\toprule & & }}
            }{%
                \ifbool{biWeekly}{\def\headerString{\toprule & & \multicolumn{2}{C?}{\textsc{Signatures}} & \multicolumn{\myNumberOfExercises}{C?}{\textsc{Exercises}}}}
                {\def\headerString{\toprule & & & \multicolumn{\myNumberOfExercises}{C?}{\textsc{Exercises}}}}
            }
        }
        %Setup of columns
        \pgfplotstableset{%
            columns/No./.style={int detect,column type=?D?,column name=\textsc{\EH@Translate{number-short}}},
            columns/Name/.style={string type,column type=C?,column name=\textsc{\EH@Translate{name}}}
        }
        \ifbool{biWeekly}{\pgfplotstableset{columns/Signature1/.style={string type,column type=S?,column name=\textsc{\EH@Translate{week} 1}}}
                          \pgfplotstableset{columns/Signature2/.style={string type,column type=S?,column name=\textsc{\EH@Translate{week} 2}}}}
                         {\pgfplotstableset{columns/Signature/.style={string type,column type=C?,column name=\textsc{\EH@Translate{signature}}}}}
        \pgfplotsforeachungrouped \j in {#1}{%
            \pgfmathsetmacro{\counter}{int(\counter+1)}
            \ifnumequal{\counter}{\myNumberOfExercises}{%
                \pgfplotstableset{columns/Ex\j/.estyle={empty cells with={},column type=E?,column name=\j}}
            }{%
                \pgfplotstableset{columns/Ex\j/.estyle={empty cells with={},column type=E|,column name=\j}}
            }
        }
        \pgfplotstableset{%
            create on use/No./.style={create col/set list={1,...,\myNumberOfStudents}},
            create on use/Name/.style={create col/set list={#5}}
        }
        \ifbool{biWeekly}{\pgfplotstableset{create on use/Signature1/.style={}, create on use/Signature2/.style={}}}
                         {\pgfplotstableset{create on use/Signature/.style={}}}
        \pgfplotsforeachungrouped \i in {#1}{%
            \pgfplotstableset{create on use/Ex\i/.style={}}
        }
        %Create actual table and print it
        \pgfplotstablenew[columns/.expand once={\colNames}]{\myNumberOfStudents}\loadedtable
        \pgfplotstabletypeset[
            columns/.expand once={\colNames},
            every even row/.style={output empty row, before row={\rowcolor{\myEveryEvenRowColor}}},
            every head row/.style={before row=\headerString\\,after row=\midrule},
            every last row/.style={output empty row, after row=\bottomrule}]{\loadedtable}
        \par% https://tex.stackexchange.com/a/91539
    \endgroup
}

\newcommand\eatlabel{}
\def\eatlabel\label#1{\label{#1}\ignorespaces}% https://tex.stackexchange.com/a/444751/128737

\newcounter{Exercise}
\newenvironmentx{exercise}[2][1=, 2=]
{
    \refstepcounter{Exercise}
    \ifstrempty{#1}{%
        \ifstrempty{#2}{%
            \noindent{\large\textbf{\EH@Translate{exercise} \theExercise}}\\[0.75ex]
        }{%
            \noindent{\large\textbf{\EH@Translate{exercise} \theExercise}}\hfill\texttt{(#2 \EH@translate{score-short})}\\[0.75ex]
        }
    }{%
        \ifstrempty{#2}{%
            \noindent{\large\textbf{\EH@Translate{exercise} \theExercise}} $\;$[\textit{#1}]\\[0.75ex]
        }{%
            \noindent{\large\textbf{\EH@Translate{exercise} \theExercise}} $\;$[\textit{#1}]\hfill\texttt{(#2 \EH@translate{score-short})}\\[0.75ex]
        }
    }
    \@ifnextchar\label
      {\eatlabel}{\ignorespaces}
}
{\par\vspace{\myskip}}

\newcounter{Solution}
\newenvironmentx{solution}[2][1=, 2=]
{
    \refstepcounter{Solution}
    \ifstrempty{#1}{%
        \ifstrempty{#2}{%
            \noindent{\large\textbf{\EH@Translate{solution-of} \theSolution}}\\[0.75ex]
        }{%
            \noindent{\large\textbf{\EH@Translate{solution-of} \theSolution}}\hfill\texttt{(#2 \EH@translate{score-short})}\\[0.75ex]
        }
    }{%
        \ifstrempty{#2}{%
            \noindent{\large\textbf{\EH@Translate{solution-of} \theSolution}} $\;$[\textit{#1}]\\[0.75ex]
        }{%
            \noindent{\large\textbf{\EH@Translate{solution-of} \theSolution}} $\;$[\textit{#1}]\hfill\texttt{(#2 \EH@translate{score-short})}\\[0.75ex]
        }
    }
    \@ifnextchar\label
      {\eatlabel}{\ignorespaces}
}
{\par\vspace{\myskip}}

\makeatother

%__END_DEFINITIONS__%
