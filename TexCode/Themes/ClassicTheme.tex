%__BEGIN_PACKAGES__%
\usepackage{babel}
\usepackage{etoolbox}
\usepackage{xargs}
\usepackage{pgfplotstable, array, booktabs, colortbl} %For \ExamCoverPage and \PresenceSheet
%__END_PACKAGES__%


%__BEGIN_DEFINITIONS__%
\pgfplotsset{compat=1.13}
\newlength{\myskip}
\setlength{\myskip}{6mm plus 1mm minus 1mm}

\newcommand{\PrintTutorList}{
    \newbool{printTutor}                    %etoolbox package
    \setbool{printTutor}{true}              %etoolbox package
    \newcounter{Tutor}
    \whileboolexpr{bool{printTutor}}{       %etoolbox package (sec. 3.6.5)
        \refstepcounter{Tutor}
        \checkTutor(\theTutor)              %arrayjob package
        \ifemptydata                        %arrayjob package
            \setbool{printTutor}{false}     %etoolbox package
        \else
            \centerline{
                \textsc{\Tutor(\theTutor):}
                \texttt{\TutorMail(\theTutor)}
            }
        \fi
    }
}

\newcommand{\Heading}[1][true]{
    \newbool{printTutorList}                %etoolbox package
    \setbool{printTutorList}{#1}            %etoolbox package
    \centerline{\Large\scshape\lecture}%
    \vskip 2pt%
    \centerline{\scshape\semester~--~\professor}%
    \vskip 3pt%
    \hrule%
    \vskip 5pt%
    \ifbool{printTutorList}{%
        \PrintTutorList%
    }{}
    \vspace{\myskip}
}

\newcommandx{\Sheet}[3][2=, 3=]{
    \ifstrempty{#2}{
        \centerline{\Large\textbf{\Translate{#1}}}
    }{
        \centerline{\Large\textbf{\Translate{#1} #2}}
    }
    % Print subtitle only for exercises
    \ifstrequal{#1}{exercise-sheet}{
        % Here we have to print as subtitle a string which is the concatenation
        % of \exerciseSheetSubtitlePrefix and #3, which could be empty or not in
        % all the possible combinations. So test them.
        \expandafter\ifstrempty\expandafter{\exerciseSheetSubtitlePrefix}{ % https://tex.stackexchange.com/a/24924
            \ifstrempty{#3}{}{
                \centerline{\textit{#3}}
            }
        }{
            \ifstrempty{#3}{
                \centerline{\textit{\exerciseSheetSubtitlePrefix}}
            }{
                \centerline{\textit{\exerciseSheetSubtitlePrefix{} #3}}
            }
        }
    }{}
    % Print current date as subtitle only for presence sheet
    \ifstrequal{#1}{presence-sheet}{
        \centerline{\today{}}
    }{}
    % Print exam date as subtitle for exam solution
    \ifstrequal{#1}{exam-solution}{
        \centerline{\Translate{exam-date}: \examDate{}}
    }{}
    \vspace{2\myskip}
}

\newcommand{\ExamCoverPage}[2]{%
    \begingroup
        \large
        \noindent\textbf{\Translate{duration}:} \examDuration  \hfill \textbf{\examDate}
        \par% https://tex.stackexchange.com/a/91539
    \endgroup
    \vfill%
    \examRules%
    \vfill%
    \begingroup
        \large
        \centering
        \begin{tabular}{rp{0.6\textwidth}}
            \Translate{full-name}:  & \underline{\hspace{0.6\textwidth}} \\[3ex]
            \Translate{ID-number}:  & \underline{\hspace{0.6\textwidth}} \\[4ex]
        \end{tabular}
        %Prepare table formatting and layout
        \setlength{\aboverulesep}{0pt}
        \setlength{\belowrulesep}{0pt}
        \renewcommand{\arraystretch}{1.8}
        \newcolumntype{?}{!{\vrule width \heavyrulewidth}}
        \newcolumntype{C}{>{\centering\arraybackslash}p{0.2\textwidth}}
        \pgfmathsetmacro{\numberOfExercises}{#1}
        %Sum exercise points -> https://tex.stackexchange.com/a/336724
        \pgfmathsetmacro{\totalScore}{0}%
        \foreach \i in {#2}{%
          \pgfmathsetmacro\totalScore{int(\totalScore+\i)}
          \xdef\totalScore{\totalScore}%
        }%
        \pgfmathparse{\totalScore}
        %Prepare and make table
        \pgfplotstableset{%
               brackets/.style={postproc cell content/.append style={/pgfplots/table/@cell content/.add={\relax$\;\quad$/}{}}},
               columns/Ex/.style={int detect,column type=?C|,column name=\textsc{\Translate{exercise}}},
               columns/Score/.style={string type, brackets, column type=C?,column name=\textsc{\Translate{score}}},
               create on use/Ex/.style={create col/set list={1,...,\numberOfExercises}},
               create on use/Score/.style={create col/set list={#2}},
        }
        \pgfplotstablenew[columns={Ex,Score}]{\numberOfExercises}{\loadedtable}
        \pgfplotstabletypeset[
               every head row/.style={before row=\toprule, after row=\midrule},
               every even row/.style={before row={\rowcolor{\myEveryEvenRowColor}}},
               every last row/.style={after row=\midrule \textsc{\Translate{sum}:} & $\;\quad/\totalScore$ \\ \bottomrule}]{\loadedtable}
        \par\vspace{\myskip}
        \newbool{examIsPassedOrFailed}
        \setbool{examIsPassedOrFailed}{\makeBinaryExam}
        \ifbool{examIsPassedOrFailed}{%
            \begin{tabular}{rp{2cm}p{2cm}}
                \Translate{passed}: & \fbox{\phantom{X}}$\quad$\Translate{yes} & \fbox{\phantom{X}}$\quad$\Translate{no} \\
            \end{tabular}
        }{%
            \begin{tabular}{rp{10cm}}
                \Translate{final-mark}:       & \underline{\hspace{9cm}} \\
            \end{tabular}
        }
        \par% https://tex.stackexchange.com/a/91539
    \endgroup
    \vfill
    \newpage%
}

\newcommand{\PresenceSheet}[5]{
    \begingroup
        \centering
        %Some macros for later
        \pgfmathsetmacro{\myNumberOfStudents}{#4}
        \pgfmathsetmacro{\myNumberOfExercises}{#3}
        \pgfmathsetmacro{\counter}{-1}
        \pgfmathsetmacro{\myColWidth}{0.31}
        \pgfmathsetmacro{\mySubColWidth}{\myColWidth / \myNumberOfExercises}
        %Table layout
        \setlength{\tabcolsep}{0pt}
        \setlength{\aboverulesep}{0pt}
        \setlength{\belowrulesep}{0pt}
        \renewcommand{\arraystretch}{2}
        \newcolumntype{C}{>{\centering\arraybackslash}p{\myColWidth\textwidth}}
        \newcolumntype{D}{>{\centering\arraybackslash}p{0.07\textwidth}}
        \newcolumntype{E}{>{\centering\arraybackslash}p{\mySubColWidth\textwidth}}
        \newcolumntype{?}{!{\vrule width \heavyrulewidth}}
        %Show/hide columns depending on user setup
        \newbool{switchOffSignatureColumnForPresenceSheet}
        \newbool{switchOffExercisesColumnForPresenceSheet}
        \setbool{switchOffSignatureColumnForPresenceSheet}{\hideSignatureColumnInPresenceSheet}
        \setbool{switchOffExercisesColumnForPresenceSheet}{\hideExercisesColumnInPresenceSheet}
        \ifbool{switchOffSignatureColumnForPresenceSheet}{%
            \ifbool{switchOffExercisesColumnForPresenceSheet}{%
                \edef\colNames{No.,Name}
            }{%
                \edef\colNames{No.,Name#2}
            }
        }{%
            \ifbool{switchOffExercisesColumnForPresenceSheet}{%
                \edef\colNames{No.,Name,Signature}
            }{%
                \edef\colNames{No.,Name,Signature#2}
            }
        }
        \ifbool{switchOffSignatureColumnForPresenceSheet}{%
            \ifbool{switchOffExercisesColumnForPresenceSheet}{%
                \def\headerString{\toprule & }
            }{%
                \def\headerString{\toprule & & \multicolumn{\myNumberOfExercises}{C?}{\textsc{Exercises}}}
            }
        }{%
            \ifbool{switchOffExercisesColumnForPresenceSheet}{%
                \def\headerString{\toprule & & }
            }{%
                \def\headerString{\toprule & & & \multicolumn{\myNumberOfExercises}{C?}{\textsc{Exercises}}}
            }
        }
        %Setup of columns
        \pgfplotstableset{%
            columns/No./.style={int detect,column type=?D?,column name=\textsc{\Translate{number-short}}},
            columns/Name/.style={string type,column type=C?,column name=\textsc{\Translate{name}}},
            columns/Signature/.style={string type,column type=C?,column name=\textsc{\Translate{signature}}}
        }
        \pgfplotsforeachungrouped \j in {#1}{%
            \pgfmathsetmacro{\counter}{int(\counter+1)}
            \ifnumequal{\counter}{\myNumberOfExercises}{%
                \pgfplotstableset{columns/Ex\j/.estyle={empty cells with={},column type=E?,column name=\j}}
            }{%
                \pgfplotstableset{columns/Ex\j/.estyle={empty cells with={},column type=E|,column name=\j}}
            }
        }
        \pgfplotstableset{%
            create on use/No./.style={create col/set list={1,...,\myNumberOfStudents}},
            create on use/Name/.style={create col/set list={#5}},
            create on use/Signature/.style={}
        }
        \pgfplotsforeachungrouped \i in {#1}{%
            \pgfplotstableset{create on use/Ex\i/.style={}}
        }
        %Create actual table and print it
        \pgfplotstablenew[columns/.expand once={\colNames}]{\myNumberOfStudents}\loadedtable
        \pgfplotstabletypeset[
            columns/.expand once={\colNames},
            every even row/.style={output empty row, before row={\rowcolor{\myEveryEvenRowColor}}},
            every head row/.style={before row=\headerString\\,after row=\midrule},
            every last row/.style={output empty row, after row=\bottomrule}]{\loadedtable}
        \par% https://tex.stackexchange.com/a/91539
    \endgroup
}

\newcounter{Exercise}
\newenvironmentx{exercise}[2][1=, 2=]
{
    \refstepcounter{Exercise}
    \ifstrempty{#1}{%
        \ifstrempty{#2}{%
            \noindent{\large\textbf{\Translate{exercise} \theExercise}}\\[0.75ex]
        }{%
            \noindent{\large\textbf{\Translate{exercise} \theExercise}}\hfill\texttt{(#2 \translate{score-short})}\\[0.75ex]
        }
    }{%
        \ifstrempty{#2}{%
            \noindent{\large\textbf{\Translate{exercise} \theExercise}} $\;$[\textit{#1}]\\[0.75ex]
        }{%
            \noindent{\large\textbf{\Translate{exercise} \theExercise}} $\;$[\textit{#1}]\hfill\texttt{(#2 \translate{score-short})}\\[0.75ex]
        }
    }
}
{\par\vspace{\myskip}}

\newcounter{Solution}
\newenvironment{solution}[1][]
{
    \refstepcounter{Solution}
    \ifstrempty{#1}{%
        \noindent{\large\textbf{\Translate{solution-of} \theSolution}}\\[0.75ex]
    }{%
        \noindent{\large\textbf{\Translate{solution-of} \theSolution}} $\;$[\textit{#1}]\\[0.75ex]
    }
}
{\par\vspace{\myskip}}


%__END_DEFINITIONS__%
